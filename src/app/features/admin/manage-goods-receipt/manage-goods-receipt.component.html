<div id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-4">
            <h1 class="mt-4">Phiếu nhập</h1>
            <div class="mb-3 d-flex flex-row-reverse">
                <button type="button" class="btn btn-dark" (click)="showDialog(null)">Thêm phiếu nhập</button>
            </div>
            <div class="card mb-4">
                <p-toast></p-toast>
                <p-confirmDialog />
                <div class="card-body">
                    <p-table #dt editMode="row" [value]="goodsReceipts" dataKey="goo_ID" [paginator]="true"
                        [rows]="10" [globalFilterFields]="['goo_ID', 'supplier_ID', 'datetime', 'total']"
                        [responsiveLayout]="'scroll'">
                        <ng-template pTemplate="caption">
                            <div class="d-flex">
                                <span class="p-input-icon-left ml-auto">
                                    <i class="pi pi-search"></i>
                                    <input pInputText type="text" style="width: 200px;"
                                        (input)="handleInput($event, dt)" placeholder="Tìm kiếm" />
                                </span>
                            </div>
                        </ng-template>
                        <ng-template pTemplate="header">
                            <tr>
                                <th style="width:15%">Mã phiếu nhập</th>
                                <th style="width:20%">Nhà cung cấp</th>
                                <th style="width:20%">Ngày nhập</th>
                                <th style="width:15%">Tổng tiền</th>
                                <th style="width:15%"></th>
                            </tr>
                        </ng-template>
                        <ng-template pTemplate="body" let-goodsReceipt let-editing="editing" let-ri="rowIndex">
                            <tr [pEditableRow]="goodsReceipt">
                                <td>{{ goodsReceipt.goo_ID }}</td>
                                <td>
                                    {{ goodsReceipt.supplier?.supplierName }}
                                </td>
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="text" [(ngModel)]="goodsReceipt.datetime" />
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{ goodsReceipt.datetime | date:'yyyy-MM-dd' }}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <p-cellEditor>
                                        <ng-template pTemplate="input">
                                            <input pInputText type="text" [(ngModel)]="goodsReceipt.total" />
                                        </ng-template>
                                        <ng-template pTemplate="output">
                                            {{ goodsReceipt.total | currency:'VND' }}
                                        </ng-template>
                                    </p-cellEditor>
                                </td>
                                <td>
                                    <div class="flex align-items-center justify-content-center gap-2">
                                        <button 
                                            pButton 
                                            pRipple 
                                            type="button"
                                            icon="pi pi-pencil" 
                                            (click)="editProduct(goodsReceipt)"
                                            class="p-button-rounded p-button-text">
                                        </button>
                                        <button 
                                            pButton 
                                            pRipple 
                                            type="button" 
                                            icon="pi pi-trash"
                                            (click)="deleteGoodsReceipt(goodsReceipt)"
                                            class="p-button-rounded p-button-text p-button-danger">
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>
            </div>
        </div>
    </main>
    <app-admin-footer></app-admin-footer>
</div>

<p-dialog header="Thêm phiếu nhập" [modal]="true" [(visible)]="visible" [style]="{ width: '55rem' }"
    styleClass="p-fluid">
    <div class="d-flex justify-content-between">
        <div>
            <p>Mã phiếu nhập:
                <input type="text" pInputText id="id" [(ngModel)]="selectedGoodsReceipt.goo_ID" disabled>
            </p>
            <p>Ngày đặt hàng: 
                <input 
                type="date" 
                pInputText 
                [ngModel]="selectedGoodsReceipt.datetime| date: 'yyyy-MM-dd'"
                name="">
            </p>
            <p>Nhà cung cấp:
                <p-dropdown [(ngModel)]="selectedGoodsReceipt.supplier_ID" [options]="suppliers"
                    optionValue="supplier_ID" optionLabel="supplierName">
                </p-dropdown>
            </p>
            <p>Tổng tiền:
                <input type="text" pInputText id="total" [value]="selectedGoodsReceipt.total| currency:'VND'" disabled>
            </p>
        </div>
        <div>
            <p-autoComplete 
                [(ngModel)]="selectedProduct" 
                [suggestions]="filteredProducts"
                (completeMethod)="filterCountry($event)" 
                (onSelect)="addProductToSelected($event)" 
                optionLabel="product.name">
                <ng-template let-productVar pTemplate="item">
                    <div class="d-flex align-items-center gap-2">
                        <img 
                            src="https://placehold.co/40x40" 
                            style="width: 40px" />
                        <div>{{ productVar.product.name }}</div>
                    </div>
                </ng-template>
            </p-autoComplete>
        </div>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Mã sản phẩm</th>
                <th>Tên sản phẩm</th>
                <th>Đơn giá</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let detail of selectedGoodsReceipt?.detailGoodsReceipts">
                <td>{{ detail.product_ID }}</td>
                <td class=" text-truncate" style="max-width: 270px;">{{ detail.productVariation?.product?.name }}</td>
                <td>{{ detail.unit_Price | currency }}</td>
                <td>{{ detail.quantity }}</td>
                <td>{{ (detail.quantity ?? 0) * (detail.unit_Price ?? 0) | currency }}</td>
            </tr>
        </tbody>
    </table>
    <div class="d-flex justify-content-end gap-2 mt-4">
        <p-button label="Ok" severity="secondary" (onClick)="visible = false" />
    </div>
</p-dialog>